version: '3.8'

services:
  # ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ REDIS ‚îÄ‚îÄ
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WORDPRESS ‚îÄ‚îÄ
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        if (!defined('WP_REDIS_HOST')) define('WP_REDIS_HOST', 'redis');
        if (!defined('WP_REDIS_PORT')) define('WP_REDIS_PORT', 6379);
        if (!defined('WP_REDIS_DATABASE')) define('WP_REDIS_DATABASE', 0);
        if (!defined('WP_REDIS_PASSWORD')) define('WP_REDIS_PASSWORD', '');
        if (!defined('WP_CACHE')) define('WP_CACHE', true);
        
        # Increase upload limits for high-resolution images
        define('WP_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        
        # PHP upload settings
        @ini_set('upload_max_filesize', '${UPLOAD_MAX_FILESIZE:-64M}');
        @ini_set('post_max_size', '${POST_MAX_SIZE:-64M}');
        @ini_set('memory_limit', '${MEMORY_LIMIT:-256M}');
        @ini_set('max_execution_time', '${MAX_EXECUTION_TIME:-300}');
        @ini_set('max_input_vars', '${MAX_INPUT_VARS:-3000}');
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WP-CLI INIT ‚îÄ‚îÄ
  wp-cli-init:
    image: wordpress:cli
    restart: "no"
    user: "33:33"
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
      INSTALL_WORDFENCE: ${INSTALL_WORDFENCE:-true}
      INSTALL_YOAST_SEO: ${INSTALL_YOAST_SEO:-true}
      INSTALL_CONTACT_FORM_7: ${INSTALL_CONTACT_FORM_7:-true}
      INSTALL_WOOCOMMERCE: ${INSTALL_WOOCOMMERCE:-true}
      INSTALL_ELEMENTOR: ${INSTALL_ELEMENTOR:-true}
      INSTALL_GOOGLE_SITE_KIT: ${INSTALL_GOOGLE_SITE_KIT:-true}
      INSTALL_UPDRAFTPLUS: ${INSTALL_UPDRAFTPLUS:-true}
      INSTALL_NS_CLONER: ${INSTALL_NS_CLONER:-true}
      HOME: /tmp
    working_dir: /var/www/html
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
    command: >
      bash -c "
      set -e
      cd /var/www/html || exit 1
      echo '‚è≥ Waiting for database and WordPress to be ready...'
      sleep 15
      echo 'üîß Setting up upload directory permissions...'
      mkdir -p /var/www/html/wp-content/uploads/2025/08 || echo '‚ö†Ô∏è  Main upload directory creation failed, continuing...'
      mkdir -p /var/www/html/wp-content/uploads/sites || echo '‚ö†Ô∏è  Multisite upload directory creation failed, continuing...'
      chmod 755 /var/www/html/wp-content || echo '‚ö†Ô∏è  wp-content permissions failed, continuing...'
      chmod 755 /var/www/html/wp-content/uploads || echo '‚ö†Ô∏è  uploads permissions failed, continuing...'
      chown -R www-data:www-data /var/www/html/wp-content/uploads || echo '‚ö†Ô∏è  Upload directory ownership failed, continuing...'
      echo 'Options -Indexes' > /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess creation failed, continuing...'
      echo 'Order deny,allow' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 1 failed, continuing...'
      echo 'Deny from all' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 2 failed, continuing...'
      echo '<FilesMatch \"\\.(jpg|jpeg|png|gif|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|zip|rar)$$\">' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 3 failed, continuing...'
      echo '    Allow from all' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 4 failed, continuing...'
      echo '</FilesMatch>' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 5 failed, continuing...'
      echo '<FilesMatch \"\\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$$\">' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 6 failed, continuing...'
      echo '    Deny from all' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 7 failed, continuing...'
      echo '</FilesMatch>' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 8 failed, continuing...'
      echo 'üîç Checking if WordPress is already installed...'
      if wp core is-installed --allow-root 2>/dev/null; then
        echo '‚úÖ WordPress is already installed!'
      else
        echo 'üìù Installing WordPress...'
        wp core install --url=\"https://\${DOMAIN_CURRENT_SITE}\" --title=\"\${WORDPRESS_TITLE}\" --admin_user=\"\${WORDPRESS_ADMIN_USER}\" --admin_password=\"\${WORDPRESS_ADMIN_PASSWORD}\" --admin_email=\"\${WORDPRESS_ADMIN_EMAIL}\" --skip-email --allow-root
        echo 'üîß Configuring WordPress...'
        wp option update home \"https://\${DOMAIN_CURRENT_SITE}\" --allow-root
        wp option update siteurl \"https://\${DOMAIN_CURRENT_SITE}\" --allow-root
        wp rewrite structure '/%postname%/' --allow-root
        wp rewrite flush --allow-root
        echo '‚úÖ WordPress installed and configured successfully!'
        echo 'üöÄ Enabling multisite...'
        wp core multisite-install --title=\"\${WORDPRESS_TITLE}\" --admin_email=\"\${WORDPRESS_ADMIN_EMAIL}\" --allow-root
        echo 'üîß Adding multisite constants to wp-config.php...'
        wp config set WP_ALLOW_MULTISITE true --raw --allow-root
        wp config set MULTISITE true --raw --allow-root
        wp config set SUBDOMAIN_INSTALL \"\${SUBDOMAIN_INSTALL:-false}\" --raw --allow-root
        wp config set DOMAIN_CURRENT_SITE \"\${DOMAIN_CURRENT_SITE}\" --allow-root
        wp config set PATH_CURRENT_SITE \"/\" --allow-root
        wp config set SITE_ID_CURRENT_SITE 1 --raw --allow-root
        wp config set BLOG_ID_CURRENT_SITE 1 --raw --allow-root
        echo 'üìÑ Creating .htaccess for multisite...'
        if [ \"\${SUBDOMAIN_INSTALL:-false}\" = \"false\" ]; then
          echo 'RewriteEngine On' > /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess creation failed, continuing...'
          echo 'RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 1 failed, continuing...'
          echo 'RewriteBase /' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 2 failed, continuing...'
          echo 'RewriteRule ^index\\.php$$ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 3 failed, continuing...'
          echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 4 failed, continuing...'
          echo '# add a trailing slash to /wp-admin' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 5 failed, continuing...'
          echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$$ $$1wp-admin/ [R=301,L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 6 failed, continuing...'
          echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 7 failed, continuing...'
          echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 8 failed, continuing...'
          echo 'RewriteCond %{REQUEST_FILENAME} -d' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 9 failed, continuing...'
          echo 'RewriteRule ^ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 10 failed, continuing...'
          echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $$2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 11 failed, continuing...'
          echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\\.php)$$ $$2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 12 failed, continuing...'
          echo 'RewriteRule . index.php [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 13 failed, continuing...'
        fi
        echo '‚úÖ WordPress Multisite setup completed!'
      fi
      "
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 