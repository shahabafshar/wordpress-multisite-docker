version: '3.8'

services:
  # ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ REDIS ‚îÄ‚îÄ
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WORDPRESS ‚îÄ‚îÄ
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_PASSWORD', '');
        define('WP_CACHE', true);
        
        # Increase upload limits for high-resolution images
        define('WP_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        
        # PHP upload settings
        @ini_set('upload_max_filesize', '${UPLOAD_MAX_FILESIZE:-64M}');
        @ini_set('post_max_size', '${POST_MAX_SIZE:-64M}');
        @ini_set('memory_limit', '${MEMORY_LIMIT:-256M}');
        @ini_set('max_execution_time', '${MAX_EXECUTION_TIME:-300}');
        @ini_set('max_input_vars', '${MAX_INPUT_VARS:-3000}');
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WP-CLI INIT ‚îÄ‚îÄ
  wp-cli-init:
    image: wordpress:cli
    restart: "no"
    user: "33:33"
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
      INSTALL_WORDFENCE: ${INSTALL_WORDFENCE:-true}
      INSTALL_YOAST_SEO: ${INSTALL_YOAST_SEO:-true}
      INSTALL_CONTACT_FORM_7: ${INSTALL_CONTACT_FORM_7:-true}
      INSTALL_WOOCOMMERCE: ${INSTALL_WOOCOMMERCE:-true}
      INSTALL_ELEMENTOR: ${INSTALL_ELEMENTOR:-true}
      INSTALL_GOOGLE_SITE_KIT: ${INSTALL_GOOGLE_SITE_KIT:-true}
      INSTALL_UPDRAFTPLUS: ${INSTALL_UPDRAFTPLUS:-true}
      INSTALL_NS_CLONER: ${INSTALL_NS_CLONER:-true}
      HOME: /tmp
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    command: >
      bash -c "
        echo '‚è≥ Waiting for database and WordPress to be ready...' &&
        sleep 15 &&
        echo 'üîß Setting up upload directory permissions...' &&
        mkdir -p /var/www/html/wp-content/uploads/2025/08 || echo '‚ö†Ô∏è  Main upload directory creation failed, continuing...' &&
        mkdir -p /var/www/html/wp-content/uploads/sites || echo '‚ö†Ô∏è  Multisite upload directory creation failed, continuing...' &&
        chown -R www-data:www-data /var/www/html/wp-content/uploads || echo '‚ö†Ô∏è  Upload directory ownership failed, continuing...' &&
        chmod -R 755 /var/www/html/wp-content/uploads || echo '‚ö†Ô∏è  Upload directory permissions failed, continuing...' &&
        echo 'Options -Indexes' > /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess creation failed, continuing...' &&
        echo 'Order deny,allow' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 1 failed, continuing...' &&
        echo 'Deny from all' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 2 failed, continuing...' &&
        echo '<FilesMatch \"\\.(jpg|jpeg|png|gif|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|zip|rar)$\">' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 3 failed, continuing...' &&
        echo '    Allow from all' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 4 failed, continuing...' &&
        echo '</FilesMatch>' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 5 failed, continuing...' &&
        echo '<FilesMatch \"\\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$\">' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 6 failed, continuing...' &&
        echo '    Deny from all' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 7 failed, continuing...' &&
        echo '</FilesMatch>' >> /var/www/html/wp-content/uploads/.htaccess || echo '‚ö†Ô∏è  Upload .htaccess rule 8 failed, continuing...' &&
        mkdir -p /var/www/html/wp-content/mu-plugins || echo '‚ö†Ô∏è  mu-plugins directory creation failed, continuing...' &&
        cat > /var/www/html/wp-content/mu-plugins/auto-create-upload-dirs.php << 'EOF'
        <?php
        add_action('wp_handle_upload', 'auto_create_upload_dirs', 10, 2);
        function auto_create_upload_dirs(\$file, \$overrides) {
            if (!is_multisite()) return \$file;
            \$blog_id = get_current_blog_id();
            \$upload_dir = wp_upload_dir();
            \$upload_path = \$upload_dir['basedir'];
            \$year = date('Y');
            \$month = date('m');
            if (\$blog_id > 1) {
                \$site_upload_path = \$upload_path . '/sites/' . \$blog_id;
                \$year_path = \$site_upload_path . '/' . \$year;
                \$month_path = \$year_path . '/' . \$month;
                if (!file_exists(\$site_upload_path)) wp_mkdir_p(\$site_upload_path);
                if (!file_exists(\$year_path)) wp_mkdir_p(\$year_path);
                if (!file_exists(\$month_path)) wp_mkdir_p(\$month_path);
                if (file_exists(\$month_path)) chmod(\$month_path, 0755);
            } else {
                \$year_path = \$upload_path . '/' . \$year;
                \$month_path = \$year_path . '/' . \$month;
                if (!file_exists(\$year_path)) wp_mkdir_p(\$year_path);
                if (!file_exists(\$month_path)) wp_mkdir_p(\$month_path);
                if (file_exists(\$month_path)) chmod(\$month_path, 0755);
            }
            return \$file;
        }
        add_action('add_attachment', 'ensure_upload_dirs_exist');
        function ensure_upload_dirs_exist(\$attachment_id) {
            \$file_path = get_attached_file(\$attachment_id);
            if (\$file_path) {
                \$upload_dir = dirname(\$file_path);
                if (!file_exists(\$upload_dir)) {
                    wp_mkdir_p(\$upload_dir);
                    chmod(\$upload_dir, 0755);
                }
            }
        }
        add_action('wpmu_new_blog', 'setup_blog_upload_dirs');
        function setup_blog_upload_dirs(\$blog_id) {
            if (\$blog_id > 1) {
                \$upload_dir = wp_upload_dir();
                \$base_upload_path = \$upload_dir['basedir'];
                \$site_upload_path = \$base_upload_path . '/sites/' . \$blog_id;
                if (!file_exists(\$site_upload_path)) {
                    wp_mkdir_p(\$site_upload_path);
                    chmod(\$site_upload_path, 0755);
                }
                \$year = date('Y');
                \$month = date('m');
                \$year_path = \$site_upload_path . '/' . \$year;
                \$month_path = \$year_path . '/' . \$month;
                if (!file_exists(\$year_path)) {
                    wp_mkdir_p(\$year_path);
                    chmod(\$year_path, 0755);
                }
                if (!file_exists(\$month_path)) {
                    wp_mkdir_p(\$month_path);
                    chmod(\$month_path, 0755);
                }
            }
        }
        EOF
        echo '‚úÖ Auto-create upload directories mu-plugin created' &&
        echo 'üîç Checking if WordPress is already installed...' &&
        if wp core is-installed --allow-root 2>/dev/null; then
          echo '‚úÖ WordPress is already installed!';
        else
          echo 'üìù Installing WordPress...' &&
          wp core install --url=\"https://\${DOMAIN_CURRENT_SITE}\" --title=\"\${WORDPRESS_TITLE}\" --admin_user=\"\${WORDPRESS_ADMIN_USER}\" --admin_password=\"\${WORDPRESS_ADMIN_PASSWORD}\" --admin_email=\"\${WORDPRESS_ADMIN_EMAIL}\" --skip-email --allow-root &&
          echo 'üîß Configuring WordPress...' &&
          wp option update home \"https://\${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update siteurl \"https://\${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update timezone_string UTC --allow-root &&
          wp option update date_format 'F j, Y' --allow-root &&
          wp option update time_format 'g:i a' --allow-root &&
          wp rewrite structure '/%postname%/' --allow-root &&
          wp rewrite flush --allow-root &&
          echo '‚úÖ WordPress installed and configured successfully!' &&
          echo 'üöÄ Enabling multisite...' &&
          wp core multisite-install --title=\"\${WORDPRESS_TITLE}\" --admin_email=\"\${WORDPRESS_ADMIN_EMAIL}\" --allow-root &&
          echo 'üîß Adding multisite constants to wp-config.php...' &&
          wp config set WP_ALLOW_MULTISITE true --raw --allow-root &&
          wp config set MULTISITE true --raw --allow-root &&
          wp config set SUBDOMAIN_INSTALL \"\${SUBDOMAIN_INSTALL:-false}\" --raw --allow-root &&
          wp config set DOMAIN_CURRENT_SITE \"\${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp config set PATH_CURRENT_SITE \"/\" --allow-root &&
          wp config set SITE_ID_CURRENT_SITE 1 --raw --allow-root &&
          wp config set BLOG_ID_CURRENT_SITE 1 --raw --allow-root &&
          echo 'üîß Ensuring multisite database tables are properly set up...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_blogs (blog_id bigint(20) NOT NULL AUTO_INCREMENT, site_id bigint(20) NOT NULL DEFAULT '1', domain varchar(200) NOT NULL DEFAULT '', path varchar(100) NOT NULL DEFAULT '', registered datetime NOT NULL DEFAULT '0000-00-00 00:00:00', last_updated datetime NOT NULL DEFAULT '0000-00-00 00:00:00', public tinyint(2) NOT NULL DEFAULT '1', archived enum('0','1') NOT NULL DEFAULT '0', mature tinyint(2) NOT NULL DEFAULT '0', spam tinyint(2) NOT NULL DEFAULT '0', deleted tinyint(2) NOT NULL DEFAULT '0', lang_id int(11) NOT NULL DEFAULT '0', PRIMARY KEY (blog_id), KEY domain (domain(50),path(5)), KEY lang_id (lang_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root || echo '‚ö†Ô∏è  wp_blogs table creation failed, continuing...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_blog_versions (blog_id bigint(20) NOT NULL DEFAULT '0', db_version varchar(20) NOT NULL DEFAULT '', last_updated datetime NOT NULL DEFAULT '0000-00-00 00:00:00', PRIMARY KEY (blog_id), KEY db_version (db_version)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root || echo '‚ö†Ô∏è  wp_blog_versions table creation failed, continuing...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_registration_log (ID bigint(20) NOT NULL AUTO_INCREMENT, email varchar(255) NOT NULL DEFAULT '', IP varchar(30) NOT NULL DEFAULT '', blog_id bigint(20) NOT NULL DEFAULT '0', date_registered datetime NOT NULL DEFAULT '0000-00-00 00:00:00', PRIMARY KEY (ID), KEY IP (IP)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root || echo '‚ö†Ô∏è  wp_registration_log table creation failed, continuing...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_signups (signup_id bigint(20) NOT NULL AUTO_INCREMENT, domain varchar(200) NOT NULL DEFAULT '', path varchar(100) NOT NULL DEFAULT '', title longtext NOT NULL, user_login varchar(60) NOT NULL DEFAULT '', user_email varchar(100) NOT NULL DEFAULT '', registered datetime NOT NULL DEFAULT '0000-00-00 00:00:00', activated datetime NOT NULL DEFAULT '0000-00-00 00:00:00', active tinyint(1) NOT NULL DEFAULT '0', activation_key varchar(50) NOT NULL DEFAULT '', meta longtext, PRIMARY KEY (signup_id), KEY activation_key (activation_key), KEY user_email (user_email), KEY user_login_email (user_login,user_email), KEY domain_path (domain,path)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root || echo '‚ö†Ô∏è  wp_signups table creation failed, continuing...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_site (id bigint(20) NOT NULL AUTO_INCREMENT, domain varchar(200) NOT NULL DEFAULT '', path varchar(100) NOT NULL DEFAULT '', PRIMARY KEY (id), KEY domain (domain(140),path(51)), KEY path (path(51))) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root || echo '‚ö†Ô∏è  wp_site table creation failed, continuing...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_sitemeta (meta_id bigint(20) NOT NULL AUTO_INCREMENT, site_id bigint(20) NOT NULL DEFAULT '0', meta_key varchar(255) DEFAULT NULL, meta_value longtext, PRIMARY KEY (meta_id), KEY meta_key (meta_key(191)), KEY site_id (site_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root || echo '‚ö†Ô∏è  wp_sitemeta table creation failed, continuing...' &&
          wp db query \"INSERT IGNORE INTO wp_blogs (blog_id, site_id, domain, path, registered, last_updated, public, archived, mature, spam, deleted, lang_id) VALUES (1, 1, '\${DOMAIN_CURRENT_SITE}', '/', NOW(), NOW(), 1, 0, 0, 0, 0, 0)\" --allow-root || echo '‚ö†Ô∏è  wp_blogs insert failed, continuing...' &&
          wp db query \"INSERT IGNORE INTO wp_blogs (blog_id, site_id, domain, path, registered, last_updated, public, archived, mature, spam, deleted, lang_id) VALUES (1, 1, '\${DOMAIN_CURRENT_SITE}', '/', NOW(), NOW(), 1, 0, 0, 0, 0, 0)\" --allow-root || echo '‚ö†Ô∏è  wp_blogs insert failed, continuing...' &&
          wp db query \"INSERT IGNORE INTO wp_site (id, domain, path) VALUES (1, '\${DOMAIN_CURRENT_SITE}', '/')\" --allow-root || echo '‚ö†Ô∏è  wp_site insert failed, continuing...' &&
          echo 'üìÑ Creating .htaccess for multisite...' &&
          if [ \"\${SUBDOMAIN_INSTALL:-false}\" = \"false\" ]; then
            echo 'RewriteEngine On' > /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess creation failed, continuing...' &&
            echo 'RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 1 failed, continuing...' &&
            echo 'RewriteBase /' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 2 failed, continuing...' &&
            echo 'RewriteRule ^index\\.php$ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 3 failed, continuing...' &&
            echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 4 failed, continuing...' &&
            echo '# add a trailing slash to /wp-admin' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 5 failed, continuing...' &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ \$1wp-admin/ [R=301,L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 6 failed, continuing...' &&
            echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 7 failed, continuing...' &&
            echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 8 failed, continuing...' &&
            echo 'RewriteCond %{REQUEST_FILENAME} -d' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 9 failed, continuing...' &&
            echo 'RewriteRule ^ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 10 failed, continuing...' &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) \$2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 11 failed, continuing...' &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\\.php)$ \$2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 12 failed, continuing...' &&
            echo 'RewriteRule . index.php [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 13 failed, continuing...';
          fi &&
          echo 'üîß Verifying multisite setup...' &&
          wp core is-installed --network --allow-root &&
          echo 'üì¶ Installing essential plugins...' &&
          if [ \"\${INSTALL_WORDFENCE:-true}\" = \"true\" ]; then if ! wp plugin is-installed wordfence --allow-root; then wp plugin install wordfence --activate-network --allow-root || echo '‚ö†Ô∏è  Wordfence installation failed, continuing...'; else echo '‚úÖ Wordfence already installed'; fi; fi &&
          if [ \"\${INSTALL_YOAST_SEO:-true}\" = \"true\" ]; then if ! wp plugin is-installed wordpress-seo --allow-root; then wp plugin install wordpress-seo --activate-network --allow-root || echo '‚ö†Ô∏è  Yoast SEO installation failed, continuing...'; else echo '‚úÖ Yoast SEO already installed'; fi; fi &&
          if [ \"\${INSTALL_CONTACT_FORM_7:-true}\" = \"true\" ]; then if ! wp plugin is-installed contact-form-7 --allow-root; then wp plugin install contact-form-7 --activate-network --allow-root || echo '‚ö†Ô∏è  Contact Form 7 installation failed, continuing...'; else echo '‚úÖ Contact Form 7 already installed'; fi; fi &&
          if [ \"\${INSTALL_GOOGLE_SITE_KIT:-true}\" = \"true\" ]; then if ! wp plugin is-installed google-site-kit --allow-root; then wp plugin install google-site-kit --activate-network --allow-root || echo '‚ö†Ô∏è  Google Site Kit installation failed, continuing...'; else echo '‚úÖ Google Site Kit already installed'; fi; fi &&
          if [ \"\${INSTALL_UPDRAFTPLUS:-true}\" = \"true\" ]; then if ! wp plugin is-installed updraftplus --allow-root; then wp plugin install updraftplus --activate-network --allow-root || echo '‚ö†Ô∏è  UpdraftPlus installation failed, continuing...'; else echo '‚úÖ UpdraftPlus already installed'; fi; fi &&
          if [ \"\${INSTALL_NS_CLONER:-true}\" = \"true\" ]; then if ! wp plugin is-installed ns-cloner-site-copier --allow-root; then wp plugin install ns-cloner-site-copier --activate-network --allow-root || echo '‚ö†Ô∏è  NS Cloner installation failed, continuing...'; else echo '‚úÖ NS Cloner already installed'; fi; fi &&
          if ! wp plugin is-installed wp-super-cache --allow-root; then wp plugin install wp-super-cache --activate-network --allow-root || echo '‚ö†Ô∏è  WP Super Cache installation failed, continuing...'; else echo '‚úÖ WP Super Cache already installed'; fi &&
          if [ \"\${INSTALL_ELEMENTOR:-true}\" = \"true\" ]; then if ! wp plugin is-installed elementor --allow-root; then wp plugin install elementor --activate-network --allow-root || echo '‚ö†Ô∏è  Elementor installation failed, continuing...'; else echo '‚úÖ Elementor already installed'; fi; fi &&
          if [ \"\${INSTALL_WOOCOMMERCE:-true}\" = \"true\" ]; then if ! wp plugin is-installed woocommerce --allow-root; then wp plugin install woocommerce --activate-network --allow-root || echo '‚ö†Ô∏è  WooCommerce installation failed, continuing...'; else echo '‚úÖ WooCommerce already installed'; fi; fi &&
          echo 'üé® Installing essential themes...' &&
          if ! wp theme is-installed twentytwentyfour --allow-root; then wp theme install twentytwentyfour --allow-root || echo '‚ö†Ô∏è  Twenty Twenty-Four theme installation failed, continuing...'; else echo '‚úÖ Twenty Twenty-Four theme already installed'; fi &&
          if ! wp theme is-installed twentytwentyfive --allow-root; then wp theme install twentytwentyfive --allow-root || echo '‚ö†Ô∏è  Twenty Twenty-Five theme installation failed, continuing...'; else echo '‚úÖ Twenty Twenty-Five theme already installed'; fi &&
          if ! wp theme is-installed hello-elementor --allow-root; then wp theme install hello-elementor --activate --allow-root || echo '‚ö†Ô∏è  Hello Elementor theme installation failed, continuing...'; else echo '‚úÖ Hello Elementor theme already installed'; fi &&
          echo 'üîß Configuring essential plugins...' &&
          wp option update blogname \"\${WORDPRESS_TITLE}\" --allow-root || echo '‚ö†Ô∏è  Blog name update failed, continuing...' &&
          wp option update blogdescription \"Professional WordPress Multisite Network\" --allow-root || echo '‚ö†Ô∏è  Blog description update failed, continuing...' &&
          wp option update users_can_register 1 --allow-root || echo '‚ö†Ô∏è  User registration setting failed, continuing...' &&
          wp option update default_role subscriber --allow-root || echo '‚ö†Ô∏è  Default role setting failed, continuing...' &&
          echo 'üîß Configuring upload limits...' &&
          wp option update upload_size_limit \"\${UPLOAD_MAX_FILESIZE:-67108864}\" --allow-root || echo '‚ö†Ô∏è  Upload size limit update failed, continuing...' &&
          wp option update post_max_size \"\${POST_MAX_SIZE:-67108864}\" --allow-root || echo '‚ö†Ô∏è  Post max size update failed, continuing...' &&
          wp option update memory_limit \"\${MEMORY_LIMIT:-268435456}\" --allow-root || echo '‚ö†Ô∏è  Memory limit update failed, continuing...' &&
          echo 'üîß Setting up basic multisite configuration...' &&
          wp site option update 1 blogname \"\${WORDPRESS_TITLE}\" --allow-root || echo '‚ö†Ô∏è  Site blog name update failed, continuing...' &&
          wp site option update 1 blogdescription 'Professional-WordPress-Multisite-Network' --allow-root || echo '‚ö†Ô∏è  Site blog description update failed, continuing...' &&
          echo '‚úÖ WordPress Multisite enabled successfully with essential plugins!' &&
          echo 'üìã Installation Summary:' &&
          echo '   - WordPress Multisite: ‚úÖ Installed' &&
          echo '   - Database Tables: ‚úÖ Created' &&
          echo '   - .htaccess: ‚úÖ Configured' &&
          echo '   - Themes: ‚úÖ Installed' &&
          echo '   - Plugins: ‚úÖ Installed (with error handling)' &&
          echo '   - Configuration: ‚úÖ Applied' &&
          echo 'üéâ Setup completed! Check logs for any warnings.';
        fi
      "
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 