version: '3.8'

services:
  # ── DATABASE ──
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # ── REDIS ──
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # ── WORDPRESS ──
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_PASSWORD', '');
        define('WP_CACHE', true);
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    networks:
      - wordpress_network

  # ── WP-CLI INIT ──
  wp-cli-init:
    image: wordpress:cli
    restart: "no"
    user: "33:33"
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
      HOME: /tmp
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    command: >
      sh -c "
        echo '⏳ Waiting for database and WordPress to be ready...' &&
        sleep 15 &&
        echo '🔍 Checking if WordPress is already installed...' &&
        if wp core is-installed --allow-root 2>/dev/null; then
          echo '✅ WordPress is already installed!';
        else
          echo '📝 Installing WordPress...' &&
          wp core install --url=\"https://$${DOMAIN_CURRENT_SITE}\" --title=\"$${WORDPRESS_TITLE}\" --admin_user=\"$${WORDPRESS_ADMIN_USER}\" --admin_password=\"$${WORDPRESS_ADMIN_PASSWORD}\" --admin_email=\"$${WORDPRESS_ADMIN_EMAIL}\" --skip-email --allow-root &&
          echo '🔧 Configuring WordPress...' &&
          wp option update home \"https://$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update siteurl \"https://$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update timezone_string UTC --allow-root &&
          wp option update date_format 'F j, Y' --allow-root &&
          wp option update time_format 'g:i a' --allow-root &&
          wp rewrite structure '/%postname%/' --allow-root &&
          wp rewrite flush --allow-root &&
          echo '✅ WordPress installed and configured successfully!' &&
          echo '🚀 Enabling multisite...' &&
          wp core multisite-install --title=\"$${WORDPRESS_TITLE}\" --admin_email=\"$${WORDPRESS_ADMIN_EMAIL}\" --allow-root &&
          echo '🔧 Adding multisite constants to wp-config.php...' &&
          wp config set WP_ALLOW_MULTISITE true --raw --allow-root &&
          wp config set MULTISITE true --raw --allow-root &&
          wp config set SUBDOMAIN_INSTALL \"$${SUBDOMAIN_INSTALL:-false}\" --raw --allow-root &&
          wp config set DOMAIN_CURRENT_SITE \"$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp config set PATH_CURRENT_SITE \"/\" --allow-root &&
          wp config set SITE_ID_CURRENT_SITE 1 --raw --allow-root &&
          wp config set BLOG_ID_CURRENT_SITE 1 --raw --allow-root &&
          echo '🔧 Ensuring multisite database tables are properly set up...' &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_blogs (blog_id bigint(20) NOT NULL AUTO_INCREMENT, site_id bigint(20) NOT NULL DEFAULT '1', domain varchar(200) NOT NULL DEFAULT '', path varchar(100) NOT NULL DEFAULT '', registered datetime NOT NULL DEFAULT '0000-00-00 00:00:00', last_updated datetime NOT NULL DEFAULT '0000-00-00 00:00:00', public tinyint(2) NOT NULL DEFAULT '1', archived enum('0','1') NOT NULL DEFAULT '0', mature tinyint(2) NOT NULL DEFAULT '0', spam tinyint(2) NOT NULL DEFAULT '0', deleted tinyint(2) NOT NULL DEFAULT '0', lang_id int(11) NOT NULL DEFAULT '0', PRIMARY KEY (blog_id), KEY domain (domain(50),path(5)), KEY lang_id (lang_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_blog_versions (blog_id bigint(20) NOT NULL DEFAULT '0', db_version varchar(20) NOT NULL DEFAULT '', last_updated datetime NOT NULL DEFAULT '0000-00-00 00:00:00', PRIMARY KEY (blog_id), KEY db_version (db_version)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_registration_log (ID bigint(20) NOT NULL AUTO_INCREMENT, email varchar(255) NOT NULL DEFAULT '', IP varchar(30) NOT NULL DEFAULT '', blog_id bigint(20) NOT NULL DEFAULT '0', date_registered datetime NOT NULL DEFAULT '0000-00-00 00:00:00', PRIMARY KEY (ID), KEY IP (IP)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_signups (signup_id bigint(20) NOT NULL AUTO_INCREMENT, domain varchar(200) NOT NULL DEFAULT '', path varchar(100) NOT NULL DEFAULT '', title longtext NOT NULL, user_login varchar(60) NOT NULL DEFAULT '', user_email varchar(100) NOT NULL DEFAULT '', registered datetime NOT NULL DEFAULT '0000-00-00 00:00:00', activated datetime NOT NULL DEFAULT '0000-00-00 00:00:00', active tinyint(1) NOT NULL DEFAULT '0', activation_key varchar(50) NOT NULL DEFAULT '', meta longtext, PRIMARY KEY (signup_id), KEY activation_key (activation_key), KEY user_email (user_email), KEY user_login_email (user_login,user_email), KEY domain_path (domain,path)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_site (id bigint(20) NOT NULL AUTO_INCREMENT, domain varchar(200) NOT NULL DEFAULT '', path varchar(100) NOT NULL DEFAULT '', PRIMARY KEY (id), KEY domain (domain(140),path(51)), KEY path (path(51))) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root &&
          wp db query \"CREATE TABLE IF NOT EXISTS wp_sitemeta (meta_id bigint(20) NOT NULL AUTO_INCREMENT, site_id bigint(20) NOT NULL DEFAULT '0', meta_key varchar(255) DEFAULT NULL, meta_value longtext, PRIMARY KEY (meta_id), KEY meta_key (meta_key(191)), KEY site_id (site_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root &&
          wp db query \"INSERT IGNORE INTO wp_blogs (blog_id, site_id, domain, path, registered, last_updated, public, archived, mature, spam, deleted, lang_id) VALUES (1, 1, '$${DOMAIN_CURRENT_SITE}', '/', NOW(), NOW(), 1, 0, 0, 0, 0, 0)\" --allow-root &&
          wp db query \"INSERT IGNORE INTO wp_site (id, domain, path) VALUES (1, '$${DOMAIN_CURRENT_SITE}', '/')\" --allow-root &&
          echo '📄 Creating .htaccess for multisite...' &&
          if [ \"$${SUBDOMAIN_INSTALL:-false}\" = \"false\" ]; then
            echo 'RewriteEngine On' > /var/www/html/.htaccess &&
            echo 'RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]' >> /var/www/html/.htaccess &&
            echo 'RewriteBase /' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^index\.php$ - [L]' >> /var/www/html/.htaccess &&
            echo '' >> /var/www/html/.htaccess &&
            echo '# add a trailing slash to /wp-admin' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]' >> /var/www/html/.htaccess &&
            echo '' >> /var/www/html/.htaccess &&
            echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> /var/www/html/.htaccess &&
            echo 'RewriteCond %{REQUEST_FILENAME} -d' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^ - [L]' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $2 [L]' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ $2 [L]' >> /var/www/html/.htaccess &&
            echo 'RewriteRule . index.php [L]' >> /var/www/html/.htaccess;
          fi &&
          echo '🔧 Verifying multisite setup...' &&
          wp core is-installed --network --allow-root &&
          echo '✅ WordPress Multisite enabled successfully!';
        fi
      "
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 