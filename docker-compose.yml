version: '3.8'

services:
  # â”€â”€ DATABASE â”€â”€
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # â”€â”€ REDIS â”€â”€
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # â”€â”€ WORDPRESS â”€â”€
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_PASSWORD', '');
        define('WP_CACHE', true);
        
        # Multisite settings (ready for manual activation)
        define('WP_ALLOW_MULTISITE', true);
        
        # Multisite constants (will be set by WP-CLI)
        define('MULTISITE', true);
        define('SUBDOMAIN_INSTALL', ${SUBDOMAIN_INSTALL:-false});
        define('DOMAIN_CURRENT_SITE', '${DOMAIN_CURRENT_SITE}');
        define('PATH_CURRENT_SITE', '/');
        define('SITE_ID_CURRENT_SITE', 1);
        define('BLOG_ID_CURRENT_SITE', 1);
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    networks:
      - wordpress_network

  # â”€â”€ WP-CLI INIT â”€â”€
  wp-cli-init:
    image: wordpress:cli
    restart: "no"
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
      - ./scripts:/scripts
    command: >
      sh -c "
        echo 'â³ Waiting for database and WordPress to be ready...' &&
        sleep 15 &&
        echo 'ðŸ” Checking if WordPress is already installed...' &&
        if wp core is-installed --allow-root 2>/dev/null; then
          echo 'âœ… WordPress is already installed!';
        else
          echo 'ðŸ“ Installing WordPress...' &&
          wp core install --url=\"$${DOMAIN_CURRENT_SITE}\" --title=\"$${WORDPRESS_TITLE}\" --admin_user=\"$${WORDPRESS_ADMIN_USER}\" --admin_password=\"$${WORDPRESS_ADMIN_PASSWORD}\" --admin_email=\"$${WORDPRESS_ADMIN_EMAIL}\" --skip-email --allow-root &&
          echo 'ðŸ”§ Configuring WordPress...' &&
          wp option update home \"http://$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update siteurl \"http://$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update timezone_string UTC --allow-root &&
          wp option update date_format 'F j, Y' --allow-root &&
          wp option update time_format 'g:i a' --allow-root &&
          wp rewrite structure '/%postname%/' --allow-root &&
          wp rewrite flush --allow-root &&
          echo 'âœ… WordPress installed and configured successfully!' &&
          echo 'ðŸ”§ Fixing permissions...' &&
          chown -R www-data:www-data /var/www/html/wp-content &&
          chmod -R 755 /var/www/html/wp-content &&
          echo 'ðŸš€ Enabling multisite...' &&
          wp core multisite-install --title=\"$${WORDPRESS_TITLE}\" --admin_email=\"$${WORDPRESS_ADMIN_EMAIL}\" --allow-root &&
          echo 'ðŸ“„ Creating .htaccess for multisite...' &&
          if [ \"$${SUBDOMAIN_INSTALL:-false}\" = \"false\" ]; then
            echo 'RewriteEngine On' > /var/www/html/.htaccess &&
            echo 'RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]' >> /var/www/html/.htaccess &&
            echo 'RewriteBase /' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^index\.php$ - [L]' >> /var/www/html/.htaccess &&
            echo '' >> /var/www/html/.htaccess &&
            echo '# add a trailing slash to /wp-admin' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]' >> /var/www/html/.htaccess &&
            echo '' >> /var/www/html/.htaccess &&
            echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> /var/www/html/.htaccess &&
            echo 'RewriteCond %{REQUEST_FILENAME} -d' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^ - [L]' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $2 [L]' >> /var/www/html/.htaccess &&
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ $2 [L]' >> /var/www/html/.htaccess &&
            echo 'RewriteRule . index.php [L]' >> /var/www/html/.htaccess;
          fi &&
          echo 'âœ… WordPress Multisite enabled successfully!';
        fi
      "
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 