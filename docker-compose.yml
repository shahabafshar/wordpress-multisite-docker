version: '3.8'

services:
  # â”€â”€ DATABASE â”€â”€
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # â”€â”€ REDIS â”€â”€
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # â”€â”€ WORDPRESS â”€â”€
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_PASSWORD', '');
        
        # Increase upload limits for high-resolution images
        define('WP_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        
        # PHP upload settings
        @ini_set('upload_max_filesize', '${UPLOAD_MAX_FILESIZE:-64M}');
        @ini_set('post_max_size', '${POST_MAX_SIZE:-64M}');
        @ini_set('memory_limit', '${MEMORY_LIMIT:-256M}');
        @ini_set('max_execution_time', '${MAX_EXECUTION_TIME:-300}');
        @ini_set('max_input_vars', '${MAX_INPUT_VARS:-3000}');
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    networks:
      - wordpress_network

  # â”€â”€ WP-CLI INIT â”€â”€
  wp-cli-init:
    image: wordpress:cli
    restart: "on-failure"
    user: "0:0"
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
      INSTALL_WORDFENCE: ${INSTALL_WORDFENCE:-true}
      INSTALL_YOAST_SEO: ${INSTALL_YOAST_SEO:-true}
      INSTALL_CONTACT_FORM_7: ${INSTALL_CONTACT_FORM_7:-true}
      INSTALL_WOOCOMMERCE: ${INSTALL_WOOCOMMERCE:-true}
      INSTALL_ELEMENTOR: ${INSTALL_ELEMENTOR:-true}
      INSTALL_GOOGLE_SITE_KIT: ${INSTALL_GOOGLE_SITE_KIT:-true}
      INSTALL_UPDRAFTPLUS: ${INSTALL_UPDRAFTPLUS:-true}
      INSTALL_NS_CLONER: ${INSTALL_NS_CLONER:-true}
      HOME: /tmp
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    command: >
      bash -c "
        echo 'ðŸš€ WP-CLI Init container starting as root...' &&
        echo 'â³ Waiting for database and WordPress to be ready...' &&
        sleep 15 &&
        echo 'ðŸ”§ Setting up upload directory permissions as root...' &&
        mkdir -p /var/www/html/wp-content/uploads/2025/08 &&
        mkdir -p /var/www/html/wp-content/uploads/sites &&
        chown -R www-data:www-data /var/www/html/wp-content/uploads &&
        chmod -R 755 /var/www/html/wp-content/uploads &&
        echo 'Options -Indexes' > /var/www/html/wp-content/uploads/.htaccess &&
        echo 'Order deny,allow' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo 'Deny from all' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo '<FilesMatch \"\\.(jpg|jpeg|png|gif|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|zip|rar)$\">' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo '    Allow from all' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo '</FilesMatch>' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo '<FilesMatch \"\\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$\">' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo '    Deny from all' >> /var/www/html/wp-content/uploads/.htaccess &&
        echo '</FilesMatch>' >> /var/www/html/wp-content/uploads/.htaccess &&
        mkdir -p /var/www/html/wp-content/mu-plugins &&
        chown -R www-data:www-data /var/www/html/wp-content/mu-plugins &&
        chmod -R 755 /var/www/html/wp-content/mu-plugins &&
        cat > /var/www/html/wp-content/mu-plugins/auto-create-upload-dirs.php << 'MUPHP'
<?php
// Temporary mu-plugin for initial setup - will be removed after setup
add_action('init', 'ensure_base_upload_structure');
function ensure_base_upload_structure() {
    if (is_multisite()) {
        $upload_dir = wp_upload_dir();
        $sites_dir = $upload_dir['basedir'] . '/sites';
        if (!file_exists($sites_dir)) {
            wp_mkdir_p($sites_dir);
        }
    }
}
MUPHP
        echo 'âœ… Temporary mu-plugin created for initial setup' &&
        echo 'ðŸ”§ Switching to www-data user for WordPress operations...' &&
        echo 'ðŸ” Checking if WordPress is already installed...' &&
        if su www-data -s /bin/bash -c 'wp core is-installed --allow-root 2>/dev/null'; then
          echo 'âœ… WordPress is already installed! Running maintenance tasks...' &&
          echo 'ðŸ”§ Configuring upload limits...' &&
          su www-data -s /bin/bash -c 'wp option update upload_size_limit \"\${UPLOAD_MAX_FILESIZE:-67108864}\" --allow-root' || echo 'âš ï¸  Upload size limit update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update post_max_size \"\${POST_MAX_SIZE:-67108864}\" --allow-root' || echo 'âš ï¸  Post max size update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update memory_limit \"\${MEMORY_LIMIT:-268435456}\" --allow-root' || echo 'âš ï¸  Memory limit update failed, continuing...' &&
          echo 'ðŸ”§ Verifying multisite setup...' &&
          if su www-data -s /bin/bash -c 'wp core is-installed --network --allow-root 2>/dev/null'; then
            echo 'âœ… Multisite is properly configured!' &&
            echo 'ðŸ”§ Updating site options...' &&
            su www-data -s /bin/bash -c 'wp site option update 1 blogname \"\${WORDPRESS_TITLE}\" --allow-root' || echo 'âš ï¸  Site blog name update failed, continuing...' &&
            su www-data -s /bin/bash -c 'wp site option update 1 blogdescription \"Professional-WordPress-Multisite-Network\" --allow-root' || echo 'âš ï¸  Site blog description update failed, continuing...';
          else
            echo 'âš ï¸  Multisite not detected, skipping multisite-specific tasks...';
          fi &&
          echo 'âœ… Maintenance tasks completed!' &&
          echo 'ðŸŽ¯ Container will exit successfully after maintenance tasks.' &&
          echo 'ðŸ”„ To run maintenance again, restart the container manually or redeploy the stack.';
        else
          echo 'ðŸ“ Installing WordPress...' &&
          su www-data -s /bin/bash -c 'wp core install --url=\"https://\${DOMAIN_CURRENT_SITE}\" --title=\"\${WORDPRESS_TITLE}\" --admin_user=\"\${WORDPRESS_ADMIN_USER}\" --admin_password=\"\${WORDPRESS_ADMIN_PASSWORD}\" --admin_email=\"\${WORDPRESS_ADMIN_EMAIL}\" --skip-email --allow-root' &&
          echo 'ðŸ”§ Configuring WordPress...' &&
          su www-data -s /bin/bash -c 'wp option update home \"https://\${DOMAIN_CURRENT_SITE}\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp option update siteurl \"https://\${DOMAIN_CURRENT_SITE}\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp option update timezone_string UTC --allow-root' &&
          su www-data -s /bin/bash -c 'wp option update date_format \"F j, Y\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp option update time_format \"g:i a\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp rewrite structure \"/%postname%/\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp rewrite flush --allow-root' &&
          echo 'âœ… WordPress installed and configured successfully!' &&
          echo 'ðŸš€ Enabling multisite...' &&
          su www-data -s /bin/bash -c 'wp core multisite-install --title=\"\${WORDPRESS_TITLE}\" --admin_email=\"\${WORDPRESS_ADMIN_EMAIL}\" --allow-root' &&
          echo 'ðŸ”§ Adding multisite constants to wp-config.php...' &&
          su www-data -s /bin/bash -c 'wp config set WP_ALLOW_MULTISITE true --raw --allow-root' &&
          su www-data -s /bin/bash -c 'wp config set MULTISITE true --raw --allow-root' &&
          su www-data -s /bin/bash -c 'wp config set SUBDOMAIN_INSTALL \"\${SUBDOMAIN_INSTALL:-false}\" --raw --allow-root' &&
          su www-data -s /bin/bash -c 'wp config set DOMAIN_CURRENT_SITE \"\${DOMAIN_CURRENT_SITE}\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp config set PATH_CURRENT_SITE \"/\" --allow-root' &&
          su www-data -s /bin/bash -c 'wp config set SITE_ID_CURRENT_SITE 1 --raw --allow-root' &&
          su www-data -s /bin/bash -c 'wp config set BLOG_ID_CURRENT_SITE 1 --raw --allow-root' &&
          echo 'ðŸ”§ Ensuring multisite database tables are properly set up...' &&
          su www-data -s /bin/bash -c 'wp db query \"CREATE TABLE IF NOT EXISTS wp_blogs (blog_id bigint(20) NOT NULL AUTO_INCREMENT, site_id bigint(20) NOT NULL DEFAULT \"1\", domain varchar(200) NOT NULL DEFAULT \"\", path varchar(100) NOT NULL DEFAULT \"\", registered datetime NOT NULL DEFAULT \"0000-00-00 00:00:00\", last_updated datetime NOT NULL DEFAULT \"0000-00-00 00:00:00\", public tinyint(2) NOT NULL DEFAULT \"1\", archived enum(\"0\",\"1\") NOT NULL DEFAULT \"0\", mature tinyint(2) NOT NULL DEFAULT \"0\", spam tinyint(2) NOT NULL DEFAULT \"0\", deleted tinyint(2) NOT NULL DEFAULT \"0\", lang_id int(11) NOT NULL DEFAULT \"0\", PRIMARY KEY (blog_id), KEY domain (domain(50),path(5)), KEY lang_id (lang_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root' || echo 'âš ï¸  wp_blogs table creation failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"CREATE TABLE IF NOT EXISTS wp_blog_versions (blog_id bigint(20) NOT NULL DEFAULT \"0\", db_version varchar(20) NOT NULL DEFAULT \"\", last_updated datetime NOT NULL DEFAULT \"0000-00-00 00:00:00\", PRIMARY KEY (blog_id), KEY db_version (db_version)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root' || echo 'âš ï¸  wp_blog_versions table creation failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"CREATE TABLE IF NOT EXISTS wp_registration_log (ID bigint(20) NOT NULL AUTO_INCREMENT, email varchar(255) NOT NULL DEFAULT \"\", IP varchar(30) NOT NULL DEFAULT \"\", blog_id bigint(20) NOT NULL DEFAULT \"0\", date_registered datetime NOT NULL DEFAULT \"0000-00-00 00:00:00\", PRIMARY KEY (ID), KEY IP (IP)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root' || echo 'âš ï¸  wp_registration_log table creation failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"CREATE TABLE IF NOT EXISTS wp_signups (signup_id bigint(20) NOT NULL AUTO_INCREMENT, domain varchar(200) NOT NULL DEFAULT \"\", path varchar(100) NOT NULL DEFAULT \"\", title longtext NOT NULL, user_login varchar(60) NOT NULL DEFAULT \"\", user_email varchar(100) NOT NULL DEFAULT \"\", registered datetime NOT NULL DEFAULT \"0000-00-00 00:00:00\", activated datetime NOT NULL DEFAULT \"0000-00-00 00:00:00\", active tinyint(1) NOT NULL DEFAULT \"0\", activation_key varchar(50) NOT NULL DEFAULT \"\", meta longtext, PRIMARY KEY (signup_id), KEY activation_key (activation_key), KEY user_email (user_email), KEY user_login_email (user_login,user_email), KEY domain_path (domain,path)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root' || echo 'âš ï¸  wp_signups table creation failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"CREATE TABLE IF NOT EXISTS wp_site (id bigint(20) NOT NULL AUTO_INCREMENT, domain varchar(200) NOT NULL DEFAULT \"\", path varchar(100) NOT NULL DEFAULT \"\", PRIMARY KEY (id), KEY domain (domain(140),path(51)), KEY path (path(51))) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root' || echo 'âš ï¸  wp_site table creation failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"CREATE TABLE IF NOT EXISTS wp_sitemeta (meta_id bigint(20) NOT NULL AUTO_INCREMENT, site_id bigint(20) NOT NULL DEFAULT \"0\", meta_key varchar(255) DEFAULT NULL, meta_value longtext, PRIMARY KEY (meta_id), KEY meta_key (meta_key(191)), KEY site_id (site_id)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\" --allow-root' || echo 'âš ï¸  wp_sitemeta table creation failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"INSERT IGNORE INTO wp_blogs (blog_id, site_id, domain, path, registered, last_updated, public, archived, mature, spam, deleted, lang_id) VALUES (1, 1, \\\"\${DOMAIN_CURRENT_SITE}\\\", \\\"/\\\", NOW(), NOW(), 1, 0, 0, 0, 0, 0)\" --allow-root || echo 'âš ï¸  wp_blogs insert failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"INSERT IGNORE INTO wp_blogs (blog_id, site_id, domain, path, registered, last_updated, public, archived, mature, spam, deleted, lang_id) VALUES (1, 1, \\\"\${DOMAIN_CURRENT_SITE}\\\", \\\"/\\\", NOW(), NOW(), 1, 0, 0, 0, 0, 0)\" --allow-root || echo 'âš ï¸  wp_blogs insert failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp db query \"INSERT IGNORE INTO wp_site (id, domain, path) VALUES (1, \\\"\${DOMAIN_CURRENT_SITE}\\\", \\\"/\\\")\" --allow-root || echo 'âš ï¸  wp_site insert failed, continuing...' &&
          echo 'ðŸ“„ Creating .htaccess for multisite...' &&
          if [ \"\${SUBDOMAIN_INSTALL:-false}\" = \"false\" ]; then
            cat > /var/www/html/.htaccess << 'HTACCESS'
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]

# add a trailing slash to /wp-admin
RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]

RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]
RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $2 [L]
RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ $2 [L]
RewriteRule . index.php [L]
HTACCESS
            chown www-data:www-data /var/www/html/.htaccess;
          fi &&
          echo 'ðŸ”§ Verifying multisite setup...' &&
          su www-data -s /bin/bash -c 'wp core is-installed --network --allow-root' &&
          echo 'ðŸ“¦ Installing essential plugins...' &&
          if [ \"\${INSTALL_WORDFENCE:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed wordfence --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install wordfence --activate-network --allow-root' || echo 'âš ï¸  Wordfence installation failed, continuing...'; else echo 'âœ… Wordfence already installed'; fi; fi &&
          if [ \"\${INSTALL_YOAST_SEO:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed wordpress-seo --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install wordpress-seo --activate-network --allow-root' || echo 'âš ï¸  Yoast SEO installation failed, continuing...'; else echo 'âœ… Yoast SEO already installed'; fi; fi &&
          if [ \"\${INSTALL_CONTACT_FORM_7:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed contact-form-7 --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install contact-form-7 --activate-network --allow-root' || echo 'âš ï¸  Contact Form 7 installation failed, continuing...'; else echo 'âœ… Contact Form 7 already installed'; fi; fi &&
          if [ \"\${INSTALL_GOOGLE_SITE_KIT:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed google-site-kit --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install google-site-kit --activate-network --allow-root' || echo 'âš ï¸  Google Site Kit installation failed, continuing...'; else echo 'âœ… Google Site Kit already installed'; fi; fi &&
          if [ \"\${INSTALL_UPDRAFTPLUS:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed updraftplus --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install updraftplus --activate-network --allow-root' || echo 'âš ï¸  UpdraftPlus installation failed, continuing...'; else echo 'âœ… UpdraftPlus already installed'; fi; fi &&
          if [ \"\${INSTALL_NS_CLONER:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed ns-cloner-site-copier --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install ns-cloner-site-copier --activate-network --allow-root' || echo 'âš ï¸  NS Cloner installation failed, continuing...'; else echo 'âœ… NS Cloner already installed'; fi; fi &&
          if ! su www-data -s /bin/bash -c 'wp plugin is-installed wp-super-cache --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install wp-super-cache --activate-network --allow-root' || echo 'âš ï¸  WP Super Cache installation failed, continuing...'; else echo 'âœ… WP Super Cache already installed'; fi &&
          if [ \"\${INSTALL_ELEMENTOR:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed elementor --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install elementor --activate-network --allow-root' || echo 'âš ï¸  Elementor installation failed, continuing...'; else echo 'âœ… Elementor already installed'; fi; fi &&
          if [ \"\${INSTALL_WOOCOMMERCE:-true}\" = \"true\" ]; then if ! su www-data -s /bin/bash -c 'wp plugin is-installed woocommerce --allow-root'; then su www-data -s /bin/bash -c 'wp plugin install woocommerce --activate-network --allow-root' || echo 'âš ï¸  WooCommerce installation failed, continuing...'; else echo 'âœ… WooCommerce already installed'; fi; fi &&
          echo 'ðŸŽ¨ Installing essential themes...' &&
          if ! su www-data -s /bin/bash -c 'wp theme is-installed twentytwentyfour --allow-root'; then su www-data -s /bin/bash -c 'wp theme install twentytwentyfour --allow-root' || echo 'âš ï¸  Twenty Twenty-Four theme installation failed, continuing...'; else echo 'âœ… Twenty Twenty-Four theme already installed'; fi &&
          if ! su www-data -s /bin/bash -c 'wp theme is-installed twentytwentyfive --allow-root'; then su www-data -s /bin/bash -c 'wp theme install twentytwentyfive --allow-root' || echo 'âš ï¸  Twenty Twenty-Five theme installation failed, continuing...'; else echo 'âœ… Twenty Twenty-Five theme already installed'; fi &&
          if ! su www-data -s /bin/bash -c 'wp theme is-installed hello-elementor --allow-root'; then su www-data -s /bin/bash -c 'wp theme install hello-elementor --activate --allow-root' || echo 'âš ï¸  Hello Elementor theme installation failed, continuing...'; else echo 'âœ… Hello Elementor theme already installed'; fi &&
          echo 'ðŸ”§ Configuring essential plugins...' &&
          su www-data -s /bin/bash -c 'wp option update blogname \"\${WORDPRESS_TITLE}\" --allow-root' || echo 'âš ï¸  Blog name update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update blogdescription \"Professional WordPress Multisite Network\" --allow-root' || echo 'âš ï¸  Blog description update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update users_can_register 1 --allow-root' || echo 'âš ï¸  User registration setting failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update default_role subscriber --allow-root' || echo 'âš ï¸  Default role setting failed, continuing...' &&
          echo 'ðŸ”§ Configuring upload limits...' &&
          su www-data -s /bin/bash -c 'wp option update upload_size_limit \"\${UPLOAD_MAX_FILESIZE:-67108864}\" --allow-root' || echo 'âš ï¸  Upload size limit update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update post_max_size \"\${POST_MAX_SIZE:-67108864}\" --allow-root' || echo 'âš ï¸  Post max size update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp option update memory_limit \"\${MEMORY_LIMIT:-268435456}\" --allow-root' || echo 'âš ï¸  Memory limit update failed, continuing...' &&
          echo 'ðŸ”§ Setting up basic multisite configuration...' &&
          su www-data -s /bin/bash -c 'wp site option update 1 blogname \"\${WORDPRESS_TITLE}\" --allow-root' || echo 'âš ï¸  Site blog name update failed, continuing...' &&
          su www-data -s /bin/bash -c 'wp site option update 1 blogdescription \"Professional-WordPress-Multisite-Network\" --allow-root' || echo 'âš ï¸  Site blog description update failed, continuing...' &&
          echo 'âœ… WordPress Multisite enabled successfully with essential plugins!' &&
          echo 'ðŸ“‹ Installation Summary:' &&
          echo '   - WordPress Multisite: âœ… Installed' &&
          echo '   - Database Tables: âœ… Created' &&
          echo '   - .htaccess: âœ… Configured' &&
          echo '   - Themes: âœ… Installed' &&
          echo '   - Plugins: âœ… Installed (with error handling)' &&
          echo '   - Configuration: âœ… Applied' &&
          echo 'ðŸŽ‰ Setup completed! Check logs for any warnings.' &&
          echo 'ðŸ§¹ Cleaning up temporary mu-plugin...' &&
          rm -f /var/www/html/wp-content/mu-plugins/auto-create-upload-dirs.php &&
          echo 'âœ… Temporary mu-plugin removed - WordPress will handle upload directories automatically' &&
          echo 'ðŸŽ¯ Container will exit successfully after installation.' &&
          echo 'ðŸ”„ To run maintenance tasks, restart the container manually or redeploy the stack.';
        fi &&
        echo 'âœ… WP-CLI Init container completed successfully!' &&
        exit 0
      "
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 