version: '3.8'

services:
  # ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ REDIS ‚îÄ‚îÄ
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WORDPRESS ‚îÄ‚îÄ
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_PASSWORD', '');
        define('WP_CACHE', true);
        
        # Multisite settings (ready for manual activation)
        define('WP_ALLOW_MULTISITE', true);
        
        # Multisite constants (will be set by WP-CLI after installation)
        # define('MULTISITE', true);
        # define('SUBDOMAIN_INSTALL', false);
        # define('DOMAIN_CURRENT_SITE', 'yourdomain.com');
        # define('PATH_CURRENT_SITE', '/');
        # define('SITE_ID_CURRENT_SITE', 1);
        # define('BLOG_ID_CURRENT_SITE', 1);
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WP-CLI INIT ‚îÄ‚îÄ
  wp-cli-init:
    image: wordpress:cli
    restart: "no"
    user: "33:33"
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
      HOME: /tmp
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
      - ./mu-plugins:/var/www/html/wp-content/mu-plugins
      - ./scripts:/scripts
    command: >
      sh -c "
        echo '‚è≥ Waiting for database and WordPress to be ready...' &&
        sleep 15 &&
        echo 'üîç Checking if WordPress is already installed...' &&
        if wp core is-installed --allow-root 2>/dev/null; then
          echo '‚úÖ WordPress is already installed!';
        else
          echo 'üìù Installing WordPress...' &&
          wp core install --url=\"$${DOMAIN_CURRENT_SITE}\" --title=\"$${WORDPRESS_TITLE}\" --admin_user=\"$${WORDPRESS_ADMIN_USER}\" --admin_password=\"$${WORDPRESS_ADMIN_PASSWORD}\" --admin_email=\"$${WORDPRESS_ADMIN_EMAIL}\" --skip-email --allow-root &&
          echo 'üîß Configuring WordPress...' &&
          wp option update home \"http://$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update siteurl \"http://$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp option update timezone_string UTC --allow-root &&
          wp option update date_format 'F j, Y' --allow-root &&
          wp option update time_format 'g:i a' --allow-root &&
          wp rewrite structure '/%postname%/' --allow-root &&
          wp rewrite flush --allow-root &&
          echo '‚úÖ WordPress installed and configured successfully!' &&
          echo 'üöÄ Enabling multisite...' &&
          wp core multisite-install --title=\"$${WORDPRESS_TITLE}\" --admin_email=\"$${WORDPRESS_ADMIN_EMAIL}\" --allow-root &&
          echo 'üîß Adding multisite constants to wp-config.php...' &&
          wp config set MULTISITE true --raw --allow-root &&
          wp config set SUBDOMAIN_INSTALL \"$${SUBDOMAIN_INSTALL:-false}\" --raw --allow-root &&
          wp config set DOMAIN_CURRENT_SITE \"$${DOMAIN_CURRENT_SITE}\" --allow-root &&
          wp config set PATH_CURRENT_SITE \"/\" --allow-root &&
          wp config set SITE_ID_CURRENT_SITE 1 --raw --allow-root &&
          wp config set BLOG_ID_CURRENT_SITE 1 --raw --allow-root &&
          echo 'üìÑ Creating .htaccess for multisite...' &&
          if [ \"$${SUBDOMAIN_INSTALL:-false}\" = \"false\" ]; then
            wp rewrite flush --hard --allow-root;
          fi &&
          echo '‚úÖ WordPress Multisite enabled successfully!';
        fi
      "
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 