version: '3.8'

services:
  # ‚îÄ‚îÄ UPLOAD PERMISSIONS FIX ‚îÄ‚îÄ
  permfix-uploads:
    image: alpine:3.20
    user: "0:0"
    restart: "no"
    command:
      - sh
      - -c
      - |
        set -e
        BASE=/mnt/wp-content/uploads
        
        # Create and permission the paths multisite needs
        install -d -o 33 -g 33 -m 2775 "$BASE"
        install -d -o 33 -g 33 -m 2775 "$BASE/sites"
        
        # Create year/month structure for current and next year
        current_year=$(date +%Y)
        next_year=$((current_year + 1))
        for year in $current_year $next_year; do
          for month in $(seq -w 1 12); do
            install -d -o 33 -g 33 -m 2775 "$BASE/$year/$month"
          done
        done
        
        # Create common plugin directories
        install -d -o 33 -g 33 -m 2775 "$BASE/elementor"
        install -d -o 33 -g 33 -m 2775 "$BASE/unlimited_elements"
        
        # Create security .htaccess
        echo "Options -Indexes" > "$BASE/.htaccess"
        echo "Order deny,allow" >> "$BASE/.htaccess"
        echo "Deny from all" >> "$BASE/.htaccess"
        echo "<FilesMatch \"\.(jpg|jpeg|png|gif|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|txt|zip|rar)\\$\">" >> "$BASE/.htaccess"
        echo "    Allow from all" >> "$BASE/.htaccess"
        echo "</FilesMatch>" >> "$BASE/.htaccess"
        echo "<FilesMatch \"\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)\\$\">" >> "$BASE/.htaccess"
        echo "    Deny from all" >> "$BASE/.htaccess"
        echo "</FilesMatch>" >> "$BASE/.htaccess"
        chown 33:33 "$BASE/.htaccess"
        
        # Fix existing contents
        chown -R 33:33 "$BASE"
        find "$BASE" -type d -exec chmod 2775 {} \;
        find "$BASE" -type f -exec chmod 664 {} \;
        
        echo "‚úÖ Upload permissions fixed successfully"
    volumes:
      - ./wp-content:/mnt/wp-content
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ
  db:
    image: mariadb:${MARIADB_VERSION:-11.5}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ REDIS ‚îÄ‚îÄ
  redis:
    image: redis:${REDIS_VERSION:-alpine}
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WORDPRESS ‚îÄ‚îÄ
  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_started
      permfix-uploads:
        condition: service_completed_successfully
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        if (!defined('WP_REDIS_HOST')) define('WP_REDIS_HOST', 'redis');
        if (!defined('WP_REDIS_PORT')) define('WP_REDIS_PORT', 6379);
        if (!defined('WP_REDIS_DATABASE')) define('WP_REDIS_DATABASE', 0);
        if (!defined('WP_REDIS_PASSWORD')) define('WP_REDIS_PASSWORD', '');
        if (!defined('WP_CACHE')) define('WP_CACHE', true);
        
        # Increase upload limits for high-resolution images
        define('WP_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${MEMORY_LIMIT:-256M}');
        
        # PHP upload settings
        @ini_set('upload_max_filesize', '${UPLOAD_MAX_FILESIZE:-64M}');
        @ini_set('post_max_size', '${POST_MAX_SIZE:-64M}');
        @ini_set('memory_limit', '${MEMORY_LIMIT:-256M}');
        @ini_set('max_execution_time', '${MAX_EXECUTION_TIME:-300}');
        @ini_set('max_input_vars', '${MAX_INPUT_VARS:-3000}');
        
        if (!defined('WP_DEBUG')) define('WP_DEBUG', false);
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', false);
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
    networks:
      - wordpress_network

  # ‚îÄ‚îÄ WP-CLI INIT ‚îÄ‚îÄ
  wp-cli-init:
    image: wordpress:cli
    restart: "no"
    user: "0:0"
    depends_on:
      db:
        condition: service_started
      wordpress:
        condition: service_started
      permfix-uploads:
        condition: service_completed_successfully
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      WORDPRESS_TITLE: ${WORDPRESS_TITLE:-WordPress Multisite}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      DOMAIN_CURRENT_SITE: ${DOMAIN_CURRENT_SITE:-localhost:8080}
      SUBDOMAIN_INSTALL: ${SUBDOMAIN_INSTALL:-false}
      INSTALL_WORDFENCE: ${INSTALL_WORDFENCE:-true}
      INSTALL_YOAST_SEO: ${INSTALL_YOAST_SEO:-true}
      INSTALL_CONTACT_FORM_7: ${INSTALL_CONTACT_FORM_7:-true}
      INSTALL_WOOCOMMERCE: ${INSTALL_WOOCOMMERCE:-true}
      INSTALL_ELEMENTOR: ${INSTALL_ELEMENTOR:-true}
      INSTALL_GOOGLE_SITE_KIT: ${INSTALL_GOOGLE_SITE_KIT:-true}
      INSTALL_UPDRAFTPLUS: ${INSTALL_UPDRAFTPLUS:-true}
      INSTALL_NS_CLONER: ${INSTALL_NS_CLONER:-true}
      HOME: /tmp
    working_dir: /var/www/html
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
    command:
      - bash
      - -c
      - |
        set -e
        cd /var/www/html || exit 1
        echo '‚è≥ Waiting for database and WordPress to be ready...'
        sleep 15
        
        echo 'üîç Checking if WordPress is already installed...'
        if su -s /bin/sh www-data -c 'wp core is-installed' 2>/dev/null; then
          echo '‚úÖ WordPress is already installed!'
          echo 'üîß Checking if multisite is enabled...'
          if su -s /bin/sh www-data -c 'wp core is-installed --network' 2>/dev/null; then
            echo '‚úÖ Multisite is already enabled!'
          else
            echo 'üöÄ Enabling multisite for existing WordPress...'
            su -s /bin/sh www-data -c "wp core multisite-install --title='${WORDPRESS_TITLE}' --admin_email='${WORDPRESS_ADMIN_EMAIL}'"
            echo 'üîß Adding multisite constants to wp-config.php...'
            su -s /bin/sh www-data -c "wp config set WP_ALLOW_MULTISITE true --raw"
            su -s /bin/sh www-data -c "wp config set MULTISITE true --raw"
            su -s /bin/sh www-data -c "wp config set SUBDOMAIN_INSTALL '${SUBDOMAIN_INSTALL:-false}' --raw"
            su -s /bin/sh www-data -c "wp config set DOMAIN_CURRENT_SITE '${DOMAIN_CURRENT_SITE}'"
            su -s /bin/sh www-data -c "wp config set PATH_CURRENT_SITE '/'"
            su -s /bin/sh www-data -c "wp config set SITE_ID_CURRENT_SITE 1 --raw"
            su -s /bin/sh www-data -c "wp config set BLOG_ID_CURRENT_SITE 1 --raw"
            echo 'üìÑ Creating .htaccess for multisite...'
            if [ "${SUBDOMAIN_INSTALL:-false}" = "false" ]; then
              echo 'RewriteEngine On' > /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess creation failed, continuing...'
              echo 'RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 1 failed, continuing...'
              echo 'RewriteBase /' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 2 failed, continuing...'
              echo 'RewriteRule ^index\.php$ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 3 failed, continuing...'
              echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 4 failed, continuing...'
              echo '# add a trailing slash to /wp-admin' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 5 failed, continuing...'
              echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 6 failed, continuing...'
              echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 7 failed, continuing...'
              echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 8 failed, continuing...'
              echo 'RewriteCond %{REQUEST_FILENAME} -d' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 9 failed, continuing...'
              echo 'RewriteRule ^ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 10 failed, continuing...'
              echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 11 failed, continuing...'
              echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ $2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 12 failed, continuing...'
              echo 'RewriteRule . index.php [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 13 failed, continuing...'
            fi
            chown www-data:www-data /var/www/html/.htaccess 2>/dev/null || echo '‚ö†Ô∏è  .htaccess ownership failed, continuing...'
          fi
        else
          echo 'üìù Installing WordPress...'
          su -s /bin/sh www-data -c "wp core install --url='https://${DOMAIN_CURRENT_SITE}' --title='${WORDPRESS_TITLE}' --admin_user='${WORDPRESS_ADMIN_USER}' --admin_password='${WORDPRESS_ADMIN_PASSWORD}' --admin_email='${WORDPRESS_ADMIN_EMAIL}' --skip-email"
          echo 'üîß Configuring WordPress...'
          su -s /bin/sh www-data -c "wp option update home 'https://${DOMAIN_CURRENT_SITE}'"
          su -s /bin/sh www-data -c "wp option update siteurl 'https://${DOMAIN_CURRENT_SITE}'"
          su -s /bin/sh www-data -c "wp rewrite structure '/%postname%/'"
          su -s /bin/sh www-data -c "wp rewrite flush"
          echo '‚úÖ WordPress installed and configured successfully!'
          echo 'üöÄ Enabling multisite...'
          su -s /bin/sh www-data -c "wp core multisite-install --title='${WORDPRESS_TITLE}' --admin_email='${WORDPRESS_ADMIN_EMAIL}'"
          echo 'üîß Adding multisite constants to wp-config.php...'
          su -s /bin/sh www-data -c "wp config set WP_ALLOW_MULTISITE true --raw"
          su -s /bin/sh www-data -c "wp config set MULTISITE true --raw"
          su -s /bin/sh www-data -c "wp config set SUBDOMAIN_INSTALL '${SUBDOMAIN_INSTALL:-false}' --raw"
          su -s /bin/sh www-data -c "wp config set DOMAIN_CURRENT_SITE '${DOMAIN_CURRENT_SITE}'"
          su -s /bin/sh www-data -c "wp config set PATH_CURRENT_SITE '/'"
          su -s /bin/sh www-data -c "wp config set SITE_ID_CURRENT_SITE 1 --raw"
          su -s /bin/sh www-data -c "wp config set BLOG_ID_CURRENT_SITE 1 --raw"
          echo 'üìÑ Creating .htaccess for multisite...'
          if [ "${SUBDOMAIN_INSTALL:-false}" = "false" ]; then
            echo 'RewriteEngine On' > /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess creation failed, continuing...'
            echo 'RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 1 failed, continuing...'
            echo 'RewriteBase /' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 2 failed, continuing...'
            echo 'RewriteRule ^index\.php$ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 3 failed, continuing...'
            echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 4 failed, continuing...'
            echo '# add a trailing slash to /wp-admin' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 5 failed, continuing...'
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 6 failed, continuing...'
            echo '' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 7 failed, continuing...'
            echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 8 failed, continuing...'
            echo 'RewriteCond %{REQUEST_FILENAME} -d' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 9 failed, continuing...'
            echo 'RewriteRule ^ - [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 10 failed, continuing...'
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) $2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 11 failed, continuing...'
            echo 'RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ $2 [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 12 failed, continuing...'
            echo 'RewriteRule . index.php [L]' >> /var/www/html/.htaccess || echo '‚ö†Ô∏è  .htaccess rule 13 failed, continuing...'
          fi
          chown www-data:www-data /var/www/html/.htaccess 2>/dev/null || echo '‚ö†Ô∏è  .htaccess ownership failed, continuing...'
          echo '‚úÖ WordPress Multisite setup completed!'
        fi
    networks:
      - wordpress_network

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

networks:
  wordpress_network:
    driver: bridge 